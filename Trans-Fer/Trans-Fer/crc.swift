//
//  crc.swift
//  Trans-Fer
//
//  Created by Pierre Molinaro on 05/04/2022.
//
//——————————————————————————————————————————————————————————————————————————————————————————————————

import Foundation

//——————————————————————————————————————————————————————————————————————————————————————————————————
// POLYNOME_PLUS1IMPLICITE : 0xC9D204F5 // Assure HD=4 jusqu'à 2147483615 bits
// https://en.wikipedia.org/wiki/Cyclic_redundancy_check
// CRC-32 : x^32 + x^26 + x^23 + x^22 + x^16 + x^12 + x^11 + x^10 + x^8 + x^7 + x^5 + x^4 + x^2 + x + 1
// En notation normale : 0x82608EDB
// http://www.sunshine2k.de/coding/javascript/crc/crc_js.html
//——————————————————————————————————————————————————————————————————————————————————————————————————

fileprivate let kTableCRC : [UInt32] = [
  0x00000000, 0x93A409EB, 0xB4EC1A3D, 0x274813D6, 0xFA7C3D91, 0x69D8347A, 0x4E9027AC, 0xDD342E47,
  0x675C72C9, 0xF4F87B22, 0xD3B068F4, 0x4014611F, 0x9D204F58, 0x0E8446B3, 0x29CC5565, 0xBA685C8E,
  0xCEB8E592, 0x5D1CEC79, 0x7A54FFAF, 0xE9F0F644, 0x34C4D803, 0xA760D1E8, 0x8028C23E, 0x138CCBD5,
  0xA9E4975B, 0x3A409EB0, 0x1D088D66, 0x8EAC848D, 0x5398AACA, 0xC03CA321, 0xE774B0F7, 0x74D0B91C,
  0x0ED5C2CF, 0x9D71CB24, 0xBA39D8F2, 0x299DD119, 0xF4A9FF5E, 0x670DF6B5, 0x4045E563, 0xD3E1EC88,
  0x6989B006, 0xFA2DB9ED, 0xDD65AA3B, 0x4EC1A3D0, 0x93F58D97, 0x0051847C, 0x271997AA, 0xB4BD9E41,
  0xC06D275D, 0x53C92EB6, 0x74813D60, 0xE725348B, 0x3A111ACC, 0xA9B51327, 0x8EFD00F1, 0x1D59091A,
  0xA7315594, 0x34955C7F, 0x13DD4FA9, 0x80794642, 0x5D4D6805, 0xCEE961EE, 0xE9A17238, 0x7A057BD3,
  0x1DAB859E, 0x8E0F8C75, 0xA9479FA3, 0x3AE39648, 0xE7D7B80F, 0x7473B1E4, 0x533BA232, 0xC09FABD9,
  0x7AF7F757, 0xE953FEBC, 0xCE1BED6A, 0x5DBFE481, 0x808BCAC6, 0x132FC32D, 0x3467D0FB, 0xA7C3D910,
  0xD313600C, 0x40B769E7, 0x67FF7A31, 0xF45B73DA, 0x296F5D9D, 0xBACB5476, 0x9D8347A0, 0x0E274E4B,
  0xB44F12C5, 0x27EB1B2E, 0x00A308F8, 0x93070113, 0x4E332F54, 0xDD9726BF, 0xFADF3569, 0x697B3C82,
  0x137E4751, 0x80DA4EBA, 0xA7925D6C, 0x34365487, 0xE9027AC0, 0x7AA6732B, 0x5DEE60FD, 0xCE4A6916,
  0x74223598, 0xE7863C73, 0xC0CE2FA5, 0x536A264E, 0x8E5E0809, 0x1DFA01E2, 0x3AB21234, 0xA9161BDF,
  0xDDC6A2C3, 0x4E62AB28, 0x692AB8FE, 0xFA8EB115, 0x27BA9F52, 0xB41E96B9, 0x9356856F, 0x00F28C84,
  0xBA9AD00A, 0x293ED9E1, 0x0E76CA37, 0x9DD2C3DC, 0x40E6ED9B, 0xD342E470, 0xF40AF7A6, 0x67AEFE4D,
  0x3B570B3C, 0xA8F302D7, 0x8FBB1101, 0x1C1F18EA, 0xC12B36AD, 0x528F3F46, 0x75C72C90, 0xE663257B,
  0x5C0B79F5, 0xCFAF701E, 0xE8E763C8, 0x7B436A23, 0xA6774464, 0x35D34D8F, 0x129B5E59, 0x813F57B2,
  0xF5EFEEAE, 0x664BE745, 0x4103F493, 0xD2A7FD78, 0x0F93D33F, 0x9C37DAD4, 0xBB7FC902, 0x28DBC0E9,
  0x92B39C67, 0x0117958C, 0x265F865A, 0xB5FB8FB1, 0x68CFA1F6, 0xFB6BA81D, 0xDC23BBCB, 0x4F87B220,
  0x3582C9F3, 0xA626C018, 0x816ED3CE, 0x12CADA25, 0xCFFEF462, 0x5C5AFD89, 0x7B12EE5F, 0xE8B6E7B4,
  0x52DEBB3A, 0xC17AB2D1, 0xE632A107, 0x7596A8EC, 0xA8A286AB, 0x3B068F40, 0x1C4E9C96, 0x8FEA957D,
  0xFB3A2C61, 0x689E258A, 0x4FD6365C, 0xDC723FB7, 0x014611F0, 0x92E2181B, 0xB5AA0BCD, 0x260E0226,
  0x9C665EA8, 0x0FC25743, 0x288A4495, 0xBB2E4D7E, 0x661A6339, 0xF5BE6AD2, 0xD2F67904, 0x415270EF,
  0x26FC8EA2, 0xB5588749, 0x9210949F, 0x01B49D74, 0xDC80B333, 0x4F24BAD8, 0x686CA90E, 0xFBC8A0E5,
  0x41A0FC6B, 0xD204F580, 0xF54CE656, 0x66E8EFBD, 0xBBDCC1FA, 0x2878C811, 0x0F30DBC7, 0x9C94D22C,
  0xE8446B30, 0x7BE062DB, 0x5CA8710D, 0xCF0C78E6, 0x123856A1, 0x819C5F4A, 0xA6D44C9C, 0x35704577,
  0x8F1819F9, 0x1CBC1012, 0x3BF403C4, 0xA8500A2F, 0x75642468, 0xE6C02D83, 0xC1883E55, 0x522C37BE,
  0x28294C6D, 0xBB8D4586, 0x9CC55650, 0x0F615FBB, 0xD25571FC, 0x41F17817, 0x66B96BC1, 0xF51D622A,
  0x4F753EA4, 0xDCD1374F, 0xFB992499, 0x683D2D72, 0xB5090335, 0x26AD0ADE, 0x01E51908, 0x924110E3,
  0xE691A9FF, 0x7535A014, 0x527DB3C2, 0xC1D9BA29, 0x1CED946E, 0x8F499D85, 0xA8018E53, 0x3BA587B8,
  0x81CDDB36, 0x1269D2DD, 0x3521C10B, 0xA685C8E0, 0x7BB1E6A7, 0xE815EF4C, 0xCF5DFC9A, 0x5CF9F571
]

//——————————————————————————————————————————————————————————————————————————————————————————————————

func accumulateByteWithLookUpTable (byte inByte : UInt8, crc ioCRC : inout UInt32) {
  let idx = (UInt8 (ioCRC >> 24) ^ inByte) & 0xFF
  ioCRC = (ioCRC << 8) ^ kTableCRC [Int (idx)]
}

//——————————————————————————————————————————————————————————————————————————————————————————————————
